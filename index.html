<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--<script src="./libs/three.js-r132/build/three.js">
    window.THREE = THREE;
    </script>-->
    
    <script src="https://unpkg.com/three@0.133.0/build/three.js"></script>
    <!--     GLTF Loader for Three.js -->
    <script src="https://unpkg.com/three@0.133.0/examples/js/loaders/GLTFLoader.js"></script>
    <!--     Orbit Controls for Three.js -->
    <script src="https://unpkg.com/three@0.133.0/examples/js/controls/OrbitControls.js"></script>
    <!--     VRM Loader for Three.js -->
    <script src="https://unpkg.com/@pixiv/three-vrm@0.6.7/lib/three-vrm.js"></script>
    
    <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
    <!--<script src="./libs/three.js-r132/examples/jsm/renderers/CSS3DRenderer.js" type="module"></script>-->
    <!--<script src="./libs/CSS3DRenderer.js" type="module"></script>-->
    <!--<script src="./libs/mindar/mindar-image-three.prod.js"></script>-->
    <!--<script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.5/dist/mindar-image-three.prod.js"></script>-->
    <!--<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>-->
  
    <!--
    <script src="./sdk/libs/mediapipe/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="./sdk/libs/mediapipe/camera_utils.js" crossorigin="anonymous"></script> 
    <script src="./sdk/libs/mediapipe/holistic.js" crossorigin="anonymous"></script>
    -->
    <!--<script src="sdk.js" type="module"></script>-->
    <script src="./animator.js" type="module"></script>
    <style>
      html, body {position: relative; margin: 0; width: 100%; height: 100%; overflow: hidden}
      #teacher_video {
        position: absolute;
        visibility: hidden; /* KILLME */
        left: 0px;
        top: 0px;
        width: 640px;
        height: 360px;
        z-index: -1;  /* KILLME */
      }
      #right_panel {
        position: absolute;
        left: 0px;
        top: 0px;
        width: 100%; /*calc(100% - 640px);*/
        height: 100%;
        z-index: -2;
        background-image: url("./assets/concert_stage.jpg");
        background-position: center;
        background-size: cover;
      }
      .output_canvas {
        /*top: 100px;*/
        z-index: -1;
      }
      #video_controls {
        position: absolute;
        visibility: collapse;
        bottom: 10px;
        left: 10px;
        z-index: 4
      }
      #teacherCanvas {
        position: absolute;
        left: 800px;
        top: 0px;
      }
      @media (max-width: 400px){
        #teacherCanvas {
          left: 200px;
        }
      }
      #video_canvas {
        position: absolute;
        left: 0px;
        top: 0px;
        z-index: 2;
      }
      #toggle {
        position: absolute;
        left: 0%;
        top: 0%;
        width: 100%;
        height: 100%;
        z-index: 3;
      }
      #btnRange {
        width: 300px;
      }
      .motion {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: 30px 30px 30px;
        z-index: 3;
      }
      #scorePanel {
          border-radius: 20px;
          position: absolute; 
          visibility: hidden;
          left: 300px;
          top: 0px;
          opacity: 80;
          background-color: white;
      }
      #matchPanel {
          position: relative;
          width: 100px;
          height: 50px;
          
      }
      #numberPanel {
          width: 100px;
          height: 50px;
          text-align: center;
          font-size: 28px;
          color: gray;
          
      }
      #matchLeft {
          position: absolute;
          border-top-left-radius: 20px;
          left: 0px;
          top: 0px;
          width: 50px;
          height: 50px;
      }
      #matchRight {
          position: absolute;
          border-top-right-radius: 20px;
          left: 50px;
          top: 0px;
          width: 50px;
          height: 50px;
      }
      #userM {
          position: absolute;
          visibility: hidden;
          left: 0px;
          top: 0px;
      }
      #teacherM {
          position: absolute;
          visibility: hidden;
          left: 600px;
          top: 0px;
      }
      .block {
          position: relative;
          width:  30px;
          height: 30px;
          border: 1px;
          border-style: solid;
          border-color: black;
      }
      .cell {
        position: absolute;
        top: 0px;
        width:  15px;
        height: 30px;
        background-color: aquamarine;
        opacity: 80%;
      }
      .cellON {
        position: absolute;
        top: 0px;
        width:  15px;
        height: 30px;
        background-color: rgb(235, 118, 229);
        opacity: 80%;
      }
      .motion > .cell {
        width: 100px;
        height: 100px;
        background-color: rgb(253, 244, 76);
      }
      .angleinfo {
          position: absolute;
          visibility: hidden;
          left: 0px;
          top: 200px;
          width: 300px;
          height: 300px;
          font-size: 60px;
          background-color: aquamarine;
          color: black
      }
      td {
        width: 100px;
      }
      #ur1 {top: 0px; left: 15px}
      #ur2 {top: 0px; left: 15px}
      #ur3 {top: 0px; left: 15px}
      #ur4 {top: 0px; left: 15px}
      #ur5 {top: 0px; left: 15px}
      #ur6 {top: 0px; left: 15px}
      #ur7 {top: 0px; left: 15px}
      #ur8 {top: 0px; left: 15px}
      #ur9 {top: 0px; left: 15px}
      #tr1 {top: 0px; left: 15px}
      #tr2 {top: 0px; left: 15px}
      #tr3 {top: 0px; left: 15px}
      #tr4 {top: 0px; left: 15px}
      #tr5 {top: 0px; left: 15px}
      #tr6 {top: 0px; left: 15px}
      #tr7 {top: 0px; left: 15px}
      #tr8 {top: 0px; left: 15px}
      #tr9 {top: 0px; left: 15px}
      #battery_panel {
        position: absolute;
        left: 300px;
        top: 150px;
      }
      @media (max-width: 400px){
        #battery_panel {
          left: 10px;
          top: 10px;
        }
        .bar {
          width: 20px;
          margin-top: 3px;
          padding: 10px;
        }
      }
      .battery {
        padding: 10px 10px;
        /*height: 340px;*/
        background-color: white;
        border: solid 10px gray;
        position: relative;
        opacity: 80%;
      }
      .battery_head {
        height: 20px;
        width: 80%;
        margin-left: 10%;
        color: white;
        text-align: center;
        background-color: gray;
        border-top-left-radius: 5px;
        border-top-right-radius: 5px;
      }
      .bar {
        cursor: pointer;
        display: block; /* inline-block; */
        width: 30px;
        border: solid thin rgba(127, 127, 127, 0.5);
        margin-top: 5px;
        padding: 14px;
        /*height: 0;*/
        background: transparent;
        transition: background 1s;
      }
      .bar.active {
        background: limegreen;
      }
    </style>
    <link rel="stylesheet" href="./style.css">
  </head>
  <body>
    <!--<video id="teacher_video" src="./assets/mock-videos/dance.mp4"></video>-->
    <!--<video id="input_video"></video> --KILL ME-->
    <div id="scorePanel">
        <div id="matchPanel">
            <div id="matchLeft"></div>
            <div id="matchRight"></div>
        </div>
        <div id="numberPanel">
            <label></label>
        </div>
    </div>
    <div id="battery_panel">
      <div class="battery_head">
          <label id="scoreNum">0</label>
      </div>
      <div class="battery">
        <div class='bar' id='100'></div>
        <div class='bar' id= '90'></div>
        <div class='bar' id= '80'></div>
        <div class='bar' id= '70'></div>
        <div class='bar' id= '60'></div>
        <div class='bar' id= '50'></div>
        <div class='bar' id= '40'></div>
        <div class='bar' id= '30'></div>
        <div class='bar' id= '20'></div>
        <div class='bar' id= '10'></div>
      </div>
    </div>
    <div class="angleinfo">
        <table style="font-size: 50px; text-align: right">
            <th>
                <td></td>
                <td>Left</td>
                <td>Right</td>
            </th>
            <tr>
                <td>H:</td>
                <td><label id="lAngleHand"></label></td>
                <td><label id="rAngleHand"></label></td>
            </tr>
            <tr>
                <td>S:</td>
                <td><label id="lAngleShoulder"></label></td>
                <td><label id="rAngleShoulder"></label></td>
            </tr>
            <tr>
                <td>H:</td>
                <td><label id="lAngleHip"></label></td>
                <td><label id="rAngleHip"></label></td>
            </tr>
        </table>
    </div>
    <div id="userM" class="motion">
      <div class="block"><div id="ul1" class="cell"></div><div id="ur3" class="cell"></div></div>
      <div class="block"><div id="ul2" class="cell"></div><div id="ur2" class="cell"></div></div>
      <div class="block"><div id="ul3" class="cell"></div><div id="ur1" class="cell"></div></div>
      <div class="block"><div id="ul4" class="cell"></div><div id="ur6" class="cell"></div></div>
      <div class="block"><div id="ul5" class="cell"></div><div id="ur5" class="cell"></div></div>
      <div class="block"><div id="ul6" class="cell"></div><div id="ur4" class="cell"></div></div>
      <div class="block"><div id="ul7" class="cell"></div><div id="ur9" class="cell"></div></div>
      <div class="block"><div id="ul8" class="cell"></div><div id="ur8" class="cell"></div></div>
      <div class="block"><div id="ul9" class="cell"></div><div id="ur7" class="cell"></div></div>
   </div>
   <div id="teacherM" class="motion">
    <div class="block"><div id="tl1" class="cell"></div><div id="tr3" class="cell"></div></div>
    <div class="block"><div id="tl2" class="cell"></div><div id="tr2" class="cell"></div></div>
    <div class="block"><div id="tl3" class="cell"></div><div id="tr1" class="cell"></div></div>
    <div class="block"><div id="tl4" class="cell"></div><div id="tr6" class="cell"></div></div>
    <div class="block"><div id="tl5" class="cell"></div><div id="tr5" class="cell"></div></div>
    <div class="block"><div id="tl6" class="cell"></div><div id="tr4" class="cell"></div></div>
    <div class="block"><div id="tl7" class="cell"></div><div id="tr9" class="cell"></div></div>
    <div class="block"><div id="tl8" class="cell"></div><div id="tr8" class="cell"></div></div>
    <div class="block"><div id="tl9" class="cell"></div><div id="tr7" class="cell"></div></div>
 </div>
    <div id="right_panel"></div>
    <a class="abs logo" href="https://metawave.click" target="_blank">
      <div style="display: flex;align-items: center;bottom: 0;right: 10px;">
        <img class="logo" src="logo.png" alt="" style="height: 50px;">
        <span class="title">MetaWave AI Lab</span>
      </div>
    </a>
    <canvas class="output_canvas" width="1000px" height="720px" left="0px"></canvas>
    <canvas id="video_canvas" width="600px" height="400px"></canvas>
    <canvas id="teacherCanvas" width="600px" height="400px"></canvas>

    <div id="logobutton">
      <img src="./setting.svg" width="32px" height="32px"/>
    </div>
    <div id="setPanel">
      <form name="myForm">
        <div>
          <label>Layout</label>
          <span class="switch-field">
            <input type="radio" id="radio-three" name="layout_switch" value="ra" checked/>
            <label for="radio-three">RA + A</label>
            <input type="radio" id="radio-four" name="layout_switch" value="ar" />
            <label for="radio-four">AR + A</label>
            <input type="radio" id="radio-five" name="layout_switch" value="a" />
            <label for="radio-five">A + A</label>
          </span>
        </div>
        <div>
          <label>Opacity</label>
          <input id="user_opacity" type="range" min="1" max="100" value="80"/>
        </div>
        <div>
          <label>Mirror</label>
          <span class="switch-field">
            <input type="radio" id="radio-threeqq" name="mirror_switch" value="yes"/>
            <label for="radio-threeqq">Yes</label>
            <input type="radio" id="radio-fourqq" name="mirror_switch" value="no" checked/>
            <label for="radio-fourqq">No</label>
          </span>
          <label>Speed</label>
          <select id="teacherSpeed">
            <option value=1>1X</option>
            <option value=0.5>0.5X</option>
            <option value=0.2>0.2X</option>
            <option value=2>2X</option>
          </select>
        </div>
      </form>
    </div>
    <div id="video_controls">
        <button id="btnPlay">Pause</button>
        <button id="btnBack">B</button>
        <input  id="btnTime" type="text"/>
        <button id="btnNext">N</button>
        <input  id="btnRange" type="range" min="1" max="100" value="0"/>
        <select id="btnSpeed">
          <option value=1>1X</option>
          <option value=0.5>0.5X</option>
          <option value=0.2>0.2X</option>
          <option value=0.2>0.1X</option>
          <option value=2>2X</option>
        </select>
        <button id="btnDump">V</button>
    </div>
    <div id="toggle"></div>
  </body>
  <!--<script src="./araisdk.prod.js" type="module"></script>-->
  <script>
    var element = document.body;
    var toggle  = document.querySelector("#toggle");
    var ui          = document.querySelector("#logobutton");
    var elmOpacity  = document.querySelector("#user_opacity");
    var elmSpeed  = document.querySelector("#teacherSpeed");
    var elmVC     = document.querySelector("#video_controls");
    
    var IsFullscreen = false;
    var IsPanel = false;

    var rad = document.myForm.layout_switch;
    var prev    = null;
    var prev_1  = null;

    const url = new URL(window.location);
    let detect = url.searchParams.get('video'); // => 'hello'
    if (detect) {
        console.log("message is " + detect);
    } else {
        console.log("no message");
    }
    if (detect) {
        elmVC.style.visibility = "visible";
    }
    
    elmSpeed.onchange = (event) => {
        changeTeacherSpeed(elmSpeed.value);
    }

    for (var i = 0; i < rad.length; i++) {
        rad[i].addEventListener('change', function() {
            (prev) ? console.log(prev.value): null;
            if (this !== prev) {
                prev = this;
            }
            console.log("change to " + this.value)
            setLayout(this.value);
            adjustPanel();
        });
    }
    rad = document.myForm.mirror_switch;
    if (rad) {
      for (var i = 0; i < rad.length; i++) {
        rad[i].addEventListener('change', function() {
            (prev_1) ? console.log(prev_1.value): null;
            if (this !== prev_1) {
                prev_1 = this;
            }
            console.log("change to " + this.value)
            setMirror((this.value == "yes") ? true: false);
            adjustPanel();
        });
      }
    }
    elmOpacity.onchange = (event) => {
        console.log("opacity=" + this.value + " " + elmOpacity.value)
        setOpacity(elmOpacity.value / 100);
        adjustPanel();
    }
    ui.onclick = () => {
        var panel= document.querySelector("#setPanel");
        
        panel.style.visibility = "visible";
        IsPanel = true;
    }
    toggle.onclick = () => {
        if (IsPanel) {
            var panel= document.querySelector("#setPanel");
        
            panel.style.visibility = "hidden";
            IsPanel = false;

            return;
        }
        if (detect) return;  // disable full screen at video detectinng

        if (IsFullscreen) {
            if (document.exitFullscreen) {
                document.exitFullscreen()
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
            IsFullscreen = false;
        } else {
            if (element.requestFullscreen) {
                element.requestFullscreen()
                .then(function() {
                    IsFullscreen = true;
                    console.log("enter fullscreenn")
                })
                .catch(function(error) {
                    console.log("fail to enter fullscreen ")
                });
            } else if (element.webkitRequestFullScreen){
                var res = element.webkitRequestFullScreen()
                IsFullscreen = true;
                console.log("enter fullscreen: " + res)
            } else {
                console.log("no fullscreen API found")
            }
        }
    }

    window.battery = function battery(charge) {
      var index = 0;
      var list = document.querySelectorAll(".battery .bar")
      list.forEach(
        function(item) {
          //console.log(item.id)

          var power = Math.round(charge / 10 * 10);
          var bar   = parseInt(item.id)
          //console.log("bar=" + bar + " power=" + power);
          if (bar <= power) {
              //console.log("add active")
              item.classList.add("active");
              index++;
          } else {
              item.classList.remove("active");
          }
      });
    }

  </script>
  <script>
    window.fbAsyncInit = function() {
      FB.init({
        appId            : '242351372483927',
        autoLogAppEvents : true,
        xfbml            : true,
        version          : 'v15.0'
      });
      FB.getLoginStatus(function(response) {
          if (response.status === 'connected') {
              // The user is logged in and has authenticated your
              // app, and response.authResponse supplies
              // the user's ID, a valid access token, a signed
              // request, and the time the access token 
              // and signed request each expire.
              var uid = response.authResponse.userID;
              var accessToken = response.authResponse.accessToken;
              console.log("FB connected");
          } else if (response.status === 'not_authorized') {
              // The user hasn't authorized your application.  They
              // must click the Login button, or you must call FB.login
              // in response to a user gesture, to launch a login dialog.
              console.log("FB not authorized");
          } else {
            // The user isn't logged in to Facebook. You can launch a
            // login dialog with a user gesture, but the user may have
            // to log in to Facebook before authorizing your application.
              console.log("FB not login");
              FB.login(function(response) {
                  if (response.status === 'connected') {
                      // Logged into your webpage and Facebook.
                      console.log("login successfully")
                  } else {
                    // The person is not logged into your webpage or we are unable to tell. 
                      console.log("login failed")
                  }
              });
          }
      });
    };
  </script>
</html>
